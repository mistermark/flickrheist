!function(e){e.fn.flickrHeist=function(t){"use strict";var o=e.extend({},e.fn.flickrHeist.defaults,t),a={REST_URL:"http://www.flickr.com/services/rest/",SEARCH:"flickr.photos.search",GETINFO:"flickr.photos.getInfo",APIKEY:o.apikey,FORMAT:"json"};a.PARAMS={SEARCH:{api_key:a.APIKEY,method:a.SEARCH,format:a.FORMAT,tags:o.tags,safe_search:o.safe_search,pages:"1",per_page:o.number_photos,nojsoncallback:"1",sort:o.sortby,extras:o.size+",geo,owner_name",has_geo:"1",min_upload_date:o.min_date},GETINFO:{method:a.GETINFO,api_key:a.APIKEY,format:a.FORMAT,nojsoncallback:"1",photo_id:null}};var r={status:null,target:this,today:(new Date).setHours(0,0,0,0),jsonmodel:{creation_date:null,real_total:null,items:[]},photoSearchUrl:a.REST_URL+"?"+e.param(a.PARAMS.SEARCH)};r.jsonmodel.creation_date=r.today;var n=function(){r.status="initialized",d()},l=function(e){return localStorage&&localStorage.getItem("flickrHeist")?!0:e},i=function(){return window.location.search.indexOf("flickrheist=debug")&&o.debug++,o.debug===!0&&o.debug++,o.debug},s=function(){return JSON.parse(localStorage.getItem("flickrHeist"))},c=function(e){(l(e)!==!0||e.creation_date!==r.today)&&localStorage.setItem("flickrHeist",JSON.stringify(e))},u=function(e){return Math.floor(Math.random()*e.real_total)},d=function(){l(r.jsonmodel)===!0&&i()<=0?f(s()):e.ajax({url:r.photoSearchUrl,dataType:"json",data:JSON,error:function(e,t){throw new Error(t)},success:function(t){r.jsonmodel.real_total=0,e.each(t.photos.photo,function(e,t){void 0!==t[o.size]&&(r.jsonmodel.real_total++,r.jsonmodel.items.push({id:t.id,details:{src:t[o.size],title:t.title,ownername:"",place_id:t.place_id,geo:{city:"",country:""},page_url:""}}))}),c(r.jsonmodel),f(r.jsonmodel)}})},p=function(t){var n=t.id,l=a.PARAMS.GETINFO,i=a.REST_URL+"?"+e.param(e.extend(l,{photo_id:n}));e.ajax({url:i,dataType:"json",data:JSON,error:function(e,t){throw new Error(t)},success:function(e){var t={owner:e.photo.owner.realname||e.photo.owner.username||"",location:e.photo.location.country._content||"",url:e.photo.urls.url[0]._content,title:e.photo.title._content},a=Handlebars.compile(o.creditstemplate);r.target.append(a(t))}})},f=function(e){var t=e.items[u(e)],a=Handlebars.compile(o.phototemplate);p(t),r.target.html(a(t)),m()},m=function(){e.isFunction(o.complete)&&o.complete.call()};return n()},e.fn.flickrHeist.defaults={apikey:null,tags:"zeitgeist",refresh:24,safe_search:"0",number_photos:"31",sortby:"interestingness-desc",random:!0,size:"url_c",min_date:"1330560000",debug:!0,phototemplate:'<div class="cover-image" style="background-image: url({{details.src}})">',creditstemplate:'<div class="cover-details"><ul class="clearfix"><li class="cover-owner"><a href="{{url}}" title="{{title}}">{{owner}}</a></li><li class="cover-location">{{location}}</li></ul></div>',complete:null}}(jQuery);